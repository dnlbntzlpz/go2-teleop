<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Temperatura en tiempo real</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f4f4f4;
            padding: 40px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: inline-block;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2rem;
        }

        #temp-value {
            font-size: 2.5rem;
            color: #0077cc;
            margin-top: 10px;
        }
        .servo-control {
            margin-top: 40px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: inline-block;
        }

        .servo-control h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .servo-control button {
            background-color: #0077cc;
            color: white;
            padding: 12px 25px;
            margin: 10px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .servo-control button:hover {
            background-color: #005fa3;
        }

        #respuesta {
            margin-top: 15px;
            font-size: 1.2rem;
            color: green;
            font-weight: bold;
        }

        canvas {
            max-width: 600px;
            margin: auto;
        }

        #alert-table {
            border-collapse: collapse;
            margin: 20px auto;
            width: 90%;
            background-color: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 1rem;
        }

        #alert-table thead {
            background-color: #ff4d4d;
            color: white;
        }

        #alert-table th, #alert-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        #alert-table tbody tr:hover {
            background-color: #ffecec;
        }

        #alert-table tbody tr:last-child td {
            border-bottom: none;
        }

    </style>
</head>
<body>
    <div class="card">
        <h1>Temperatura actual</h1>
        <div id="temp-value">-- °C</div>
        <div id="alert-box" style="margin-top: 20px; font-size: 1.2rem; color: red; display: none;">
            🔥 ¡Temperatura elevada!
        </div>
        <div id="fan-message" style="margin-top: 10px; font-weight: bold; color: #007700;"></div>
    </div>

    <canvas id="tempChart" width="600" height="300"></canvas>

    <h2 style="margin-top: 40px;">🚨 Historial de Alertas</h2>
    <table id="alert-table" border="1" cellpadding="10" style="margin: 20px auto; border-collapse: collapse; width: 90%;">
        <thead>
            <tr>
                <th>Fecha y hora</th>
                <th>Temperatura (°C)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Cámara USB</h2>
    <img id="usb-cam-img" width="480">
    <button onclick="capturar()">Capturar Entorno</button>
    <p id="descripcion"></p>

    <h2>Go2 - Cámara remota</h2>
    <iframe src="http://<IP_DEL_GO2>:<PUERTO>" width="480" height="320"></iframe>

    <!-- 🧠 Sección del Servo -->
    <div class="servo-control">
        <h2>🔧 Control de Caja</h2>

        <input type="text" id="comandoTexto" placeholder="Escribe: abrir o cerrar..." style="padding: 10px; width: 250px; border-radius: 8px; border: 1px solid #ccc;">
        <br>
        <button onclick="enviarTexto()">Enviar texto</button>
        <button onclick="grabarAudio()">🎤 Voz</button>
        <input id="input-comando" type="text">
        <button onclick="enviarComando(document.getElementById('input-comando').value)">Enviar comando</button>

        <p id="respuesta">Esperando comando...</p>
    </div>

    <h3>Cámara USB (vista en vivo)</h3>
    <img id="usb-camera" src="{{ url_for('video_feed_usb') }}" width="480" height="360">

    <script>
        let soundInterval;
        const tempElement = document.getElementById('temp-value');
        const ctx = document.getElementById('tempChart').getContext('2d');

        const tempChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // tiempos
                datasets: [{
                    label: 'Temperatura (°C)',
                    data: [],
                    borderColor: '#0077cc',
                    backgroundColor: 'rgba(0, 119, 204, 0.1)',
                    tension: 0.2,
                    pointRadius: 3,
                }]
            },
            options: {
                scales: {
                    x: {
                        title: { display: true, text: 'Hora' }
                    },
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: '°C' }
                    }
                }
            }
        });

        function fetchTemperature() {
            fetch('/api/sensor-data')
                .then(response => response.json())
                .then(data => {
                    const temp = data.temperature;
                    const now = new Date().toLocaleTimeString();
                    const tempElement = document.getElementById('temp-value');
                    const alertBox = document.getElementById('alert-box');
                    const alertSound = document.getElementById('alert-sound');
                    const fanMessageBox = document.getElementById('fan-message');

                    if (temp !== null) {
                        tempElement.textContent = `${temp} °C`;
                        fanMessageBox.textContent = data.fan_message || '';

                        // Mostrar alerta si la temperatura supera 25 °C
                        if (temp > 25) {
                        alertBox.style.display = 'block';

                        // Si aún no está sonando en bucle
                            if (!soundInterval) {
                                alertSound.play();
                                soundInterval = setInterval(() => {
                                    alertSound.play();
                                }, 5000); // Suena cada 5 segundos
                            }

                        } else {
                            alertBox.style.display = 'none';

                            // Detener el sonido
                            if (soundInterval) {
                                clearInterval(soundInterval);
                                soundInterval = null;
                            }
                        }


                        // Agregar datos
                        tempChart.data.labels.push(now);
                        tempChart.data.datasets[0].data.push(temp);

                        // Limitar a 10 puntos
                        if (tempChart.data.labels.length > 10) {
                            tempChart.data.labels.shift();
                            tempChart.data.datasets[0].data.shift();
                        }

                        tempChart.update();
                    } else {
                        tempElement.textContent = 'Error al leer';
                        alertBox.style.display = 'none';

                        // Asegurar que se detenga el sonido si hay error
                        if (soundInterval) {
                            clearInterval(soundInterval);
                            soundInterval = null;
                        }
                    }
                })
                .catch(err => {
                    document.getElementById('temp-value').textContent = 'Sin conexión';
                    document.getElementById('alert-box').style.display = 'none';

                    if (soundInterval) {
                        clearInterval(soundInterval);
                        soundInterval = null;
                    }

                    console.error('Error:', err);
                });
        }


        function loadAlerts() {
            fetch('/api/alerts')
                .then(response => response.json())
                .then(alerts => {
                    const tableBody = document.querySelector('#alert-table tbody');
                    tableBody.innerHTML = '';

                    alerts.forEach(alert => {
                        const row = document.createElement('tr');
                        const dateCell = document.createElement('td');
                        const tempCell = document.createElement('td');

                        dateCell.textContent = new Date(alert.timestamp).toLocaleString();
                        tempCell.textContent = `🔥 ${alert.temperature.toFixed(2)} °C`;


                        row.appendChild(dateCell);
                        row.appendChild(tempCell);
                        tableBody.appendChild(row);
                    });
                });
        }

        // Cargar alertas inicialmente y luego cada 30 segundos
        loadAlerts();
        setInterval(loadAlerts, 30000);

        setInterval(fetchTemperature, 2000);
        fetchTemperature();

        // 🧠 Funciones de control del servo
        async function enviarTexto() {
            const comando = document.getElementById("comandoTexto").value;
            const res = await fetch('/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ comando })
            });
            const data = await res.json();
            document.getElementById("respuesta").innerText = data.accion;
        }

        async function grabarAudio() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const mediaRecorder = new MediaRecorder(stream);
            let chunks = [];

            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'audio/wav' });
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64Audio = reader.result.split(',')[1];
                    const res = await fetch('/voz', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ audio: base64Audio })
                    });
                    const data = await res.json();
                    if (data.texto) {
                        document.getElementById("comandoTexto").value = data.texto;
                        enviarTexto();
                    } else {
                        document.getElementById("respuesta").innerText = "No se entendió el audio";
                    }
                };
                reader.readAsDataURL(blob);
            };

            mediaRecorder.start();
            setTimeout(() => mediaRecorder.stop(), 3000); // graba 3 segundos
        }   
        
        function reproducirAudioEstado(estado) {
            const audios = {
                "abriendo": document.getElementById("puerta-abriendo"),
                "cerrando": document.getElementById("puerta-cerrando"),
                "abierta": document.getElementById("puerta-abierta"),
                "cerrada": document.getElementById("puerta-cerrada")
            };
            const audio = audios[estado];
            if (audio) {
                audio.play().catch(err => console.warn('Error al reproducir audio:', err));
            }
        }

        // Lógica para enviar el comando al backend y reproducir el audio
        function enviarComando(comando) {
            fetch("/control", {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({comando})
            })
            .then(res => res.json())
            .then(data => {
                const accion = data.accion.toLowerCase(); // ejemplo: "caja abierta"
                if (accion.includes("abierta")) {
                    reproducirAudioEstado("abriendo");
                    setTimeout(() => reproducirAudioEstado("abierta"), 1000);
                } else if (accion.includes("cerrada")) {
                    reproducirAudioEstado("cerrando");
                    setTimeout(() => reproducirAudioEstado("cerrada"), 1000);
                }
            });
        }
        function capturar() {
            fetch('/describe-environment', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('descripcion').innerText = data.descripcion;
                })
                .catch(err => alert("Error: " + err));
        }               
    </script>
    <audio id="alert-sound" src="{{ url_for('static', filename='Sounds/alerta_1.mp3') }}" preload="auto"></audio>
    <audio id="puerta-abierta" src="{{ url_for('static', filename='Sounds/abierta.mp3') }}" preload="auto"></audio>
    <audio id="puerta-cerrada" src="{{ url_for('static', filename='Sounds/cerrada.mp3') }}" preload="auto"></audio>
    <audio id="puerta-abriendo" src="{{ url_for('static', filename='Sounds/abriendo.mp3') }}" preload="auto"></audio>
    <audio id="puerta-cerrando" src="{{ url_for('static', filename='Sounds/cerrando.mp3') }}" preload="auto"></audio>
</body>
</html>